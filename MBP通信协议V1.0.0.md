# MBP通信协议

**该文档中所有讯息均为json串**

### 一、端站上报信息

当端站进行状态上报时（`op`为`"report"`，`op_sub`为`"state"`），其发送的JSON载荷包含以下字段。

| 字段名                    | 字段类型 | 字段内容示例             | 备注 (verbose_name, 约束)                                    |
| ------------------------- | -------- | ------------------------ | ------------------------------------------------------------ |
| **type**                  | String   | `"MBP-N28 船载伺服基站"` | 设备类型名。**不可为空**。与sn, report_date, report_time构成复合唯一约束。 |
| **sn**                    | String   | `"sn000004"`             | 设备序列号。**不可为空**。                                   |
| **report_date**           | Date     | `"2025-09-11"`           | 上报日期 (格式: YYYY-MM-DD)。**不可为空**。                  |
| **report_time**           | Time     | `"00:50:53"`             | 上报时间 (格式: HH:MM:SS)。**不可为空**。                    |
| **op**                    | String   | `"report"`               | 操作类型。                                                   |
| **op_sub**                | String   | `"state"`                | 操作子类。                                                   |
| **system_stat**           | Integer  | `0`                      | 系统状态。可为空。                                           |
| **wireless_network_stat** | Integer  | `0`                      | 无线网络状态。可为空。                                       |
| **long**                  | Float    | `0.5`                    | 端站经度。可为空。                                           |
| **lat**                   | Float    | `0.5`                    | 端站纬度。可为空。                                           |
| **theory_yaw**            | Float    | `0.0`                    | 理论方位角。可为空。                                         |
| **yaw**                   | Float    | `270.0`                  | 当前方位角。可为空。                                         |
| **pitch**                 | Float    | `0.4000000059604645`     | 当前俯仰角。可为空。                                         |
| **roll**                  | Float    | `-1.5`                   | 当前横滚角。可为空。                                         |
| **yao_limit_state**       | Float    | `0`                      | 方位限位。可为空。                                           |
| **temp**                  | Float    | `0.0`                    | 温度(°C)。可为空。                                           |
| **humi**                  | Float    | `0.0`                    | 湿度(%)。可为空。                                            |
| **bts_name**              | String   | `"2号基站"`              | 基站名。可为空。                                             |
| **bts_long**              | Float    | `0.0`                    | 基站经度。可为空。                                           |
| **bts_lat**               | Float    | `0.0`                    | 基站纬度。可为空。                                           |
| **bts_number**            | Integer  | `2`                      | 基站编号。可为空。                                           |
| **bts_group_number**      | Integer  | `1`                      | 基站分区号。可为空。                                         |
| **bts_r**                 | Float    | `60.0`                   | 基站覆盖半径(公里)。可为空。                                 |
| **upstream_rate**         | Float    | `0`                      | 上行速率(Mbps)。可为空。                                     |
| **downstream_rate**       | Float    | `0`                      | 下行速率(Mbps)。可为空。                                     |
| **standard**              | String   | `"NR"`                   | 通信制式。可为空。                                           |
| **plmn**                  | String   | `"46011"`                | 运营商PLMN。可为空。                                         |
| **cellid**                | String   | `"0"`                    | 服务小区CellID。可为空。                                     |
| **pci**                   | Integer  | `219`                    | 服务小区PCI。可为空。                                        |
| **rsrp**                  | Float    | `-92`                    | RSRP(信号接收功率)。可为空。                                 |
| **sinr**                  | Float    | `13`                     | SINR(信噪比)。可为空。                                       |
| **rssi**                  | Float    | `null`                   | RSSI(信号强度指示)。可为空。                                 |

端站上报消息示例：

```json
{"type": "MBP-N28 \u8239\u8f7d\u4f3a\u670d\u57fa\u7ad9", "sn": "sn000004", "op": "report", "op_sub": "state", "date": "2025-09-11", "time": "00:50:53", "system_stat": 0, "wireless_network_stat": 0, "long": 0.5, "lat": 0.5, "theory_yaw": 0.0, "yaw": 270.0, "pitch": 0.4000000059604645, "roll": -1.5, "yao_limit_state": 0, "temp": 0.0, "humi": 0.0, "bts_name": "2号基站", "bts_long": 0.0, "bts_lat": 0.0, "bts_no": 2, "bts_group_no": 1, "bts_r": 60.0,  "upstream_rate": 0, "downstream_rate": 0, "standard": "NR", "plmn": 46011, "cellid": 0, "pci": 219, "rsrp": -92, "sinr": 13, "rssi": "N/A"}
```



**以下所有服务端下发请求和端站应答均应当包含request_id字段（uuid），用于实现请求和响应的一一匹配，下文中所有消息省略该字段，不做重复说明**

### 二、端站数据与状态

#### 1、查询工作模式

服务端下发请求：

| 字段     | 内容示例       | 备注                   |
| -------- | -------------- | ---------------------- |
| "sn"     | "SN000001"     | 设备序列号             |
| "op"     | "query"        | 操作类型：查询         |
| "op_sub" | "work_pattern" | 操作子类：查询工作模式 |

端站应答：

| 字段      | 内容示例       | 备注                     |
| --------- | -------------- | ------------------------ |
| "sn"      | "SN000001"     | 设备序列号               |
| "op"      | "query_ans"    | 操作类型：查询（响应）   |
| "op_sub"  | "work_pattern" | 操作子类：查询工作模式   |
| "pattern" | "0"            | 0：自动模式，1：手动模式 |

#### 2、设置工作模式

服务端下发请求：

| 字段      | 内容示例          | 备注                       |
| --------- | ----------------- | -------------------------- |
| "sn"      | "SN000001"        | 设备序列号                 |
| "op"      | "antenna_control" | 操作类型：天线控制         |
| "op_sub"  | "work_pattern"    | 操作子类：设置天线工作模式 |
| "pattern" | "0"               | 0：自动模式，1：手动模式   |

端站应答：==result修改==（已完成

| 字段     | 内容示例              | 备注                                                     |
| -------- | --------------------- | -------------------------------------------------------- |
| "sn"     | "SN000001"            | 设备序列号                                               |
| "op"     | "antenna_control_ans" | 操作类型：天线控制（响应）                               |
| "op_sub" | "work_pattern"        | 操作子类：设置天线工作模式                               |
| "result" | "0"                   | 0：操作成功，1：操作失败                                 |
| "error"  | ""                    | 操作成功时为空，操作失败时失败信息（如失败原因、报错等） |

#### 3、查询设备状态

服务端下发请求：

| 字段     | 内容示例           | 备注                   |
| -------- | ------------------ | ---------------------- |
| "sn"     | "SN000001"         | 设备序列号             |
| "op"     | "query"            | 操作类型：查询         |
| "op_sub" | "equipment_status" | 操作子类：查询设备状态 |

端站应答：

| 字段              | 内容示例           | 备注                         |
| ----------------- | ------------------ | ---------------------------- |
| "sn"              | "SN000001"         | 设备序列号                   |
| "op"              | "query_ans"        | 操作类型：查询（响应）       |
| "op_sub"          | "equipment_status" | 操作子类：查询设备状态       |
| "IMU_stat"        | 0                  | 0：正常，1：异常             |
| "DGPS_stat"       | 0                  | 0：正常，1：异常             |
| "storage_stat"    | 0                  | 0：正常，1：异常             |
| "yaw_moto_stat"   | 0                  | 0：正常，1：异常             |
| "pitch_moto_stat" | 0                  | 0：正常，1：异常             |
| "yaw_lim_stat"    | 0                  | 0：正常，1：异常（到达限位） |
| "pitch_lim_stat"  | 0                  | 0：正常，1：异常（到达限位） |

#### 4、手动控制天线

服务端下发请求：

| 字段     | 内容示例          | 备注                                   |
| -------- | ----------------- | -------------------------------------- |
| "sn"     | "SN000001"        | 设备序列号                             |
| "op"     | "antenna_control" | 操作类型：天线控制                     |
| "op_sub" | "rotate"          | 操作子类：控制天线旋转                 |
| "mode"   | "0"               | 0：增量模式，1：绝对值模式             |
| "axis"   | "0"               | 与direct联动，确定旋转方向，具体见附表 |
| "direct" | "0"               | 与axis联动，确定旋转方向，具体见附表   |
| "angle"  | "1.1"             | 旋转角度                               |

端站应答：==result修改==（已完成

| 字段     | 内容示例              | 备注                                                     |
| -------- | --------------------- | -------------------------------------------------------- |
| "sn"     | "SN000001"            | 设备序列号                                               |
| "op"     | "antenna_control_ans" | 操作类型：天线控制（响应）                               |
| "op_sub" | "rotate"              | 操作子类：控制天线旋转                                   |
| "result" | "0"                   | 0：操作成功，1：操作失败                                 |
| "error"  | ""                    | 操作成功时为空，操作失败时失败信息（如失败原因、报错等） |

附表——axis, direct与按键对应关系：

| axis取值 | direct取值 | 对应网页按键 |
| -------- | ---------- | ------------ |
| 0        | 0          | 右           |
| 0        | 1          | 左           |
| 1        | 0          | 上           |
| 1        | 1          | 下           |



### 三、端站系统管理

#### 1、查询工作模式

与“端站数据与状态”完全相同

#### 2、设置工作模式

与“端站数据与状态”完全相同

#### 3、系统复位

服务端下发请求：==增加字段，修改op_sub==（已完成

| 字段       | 内容示例          | 备注                     |
| ---------- | ----------------- | ------------------------ |
| "sn"       | "SN000001"        | 设备序列号               |
| "op"       | "antenna_control" | 操作类型：天线控制       |
| "op_sub"   | "adu_rst"         | 操作子类：天线复位       |
| "rst_type" | "0"               | 0：业务复位，1：软件复位 |

端站响应：==增加字段，修改op_sub，修改result==（已完成

| 字段     | 内容示例              | 备注                                                     |
| -------- | --------------------- | -------------------------------------------------------- |
| "sn"     | "SN000001"            | 设备序列号                                               |
| "op"     | "antenna_control_ans" | 操作类型：天线控制（响应）                               |
| "op_sub" | "adu_rst"             | 操作子类：天线复位                                       |
| "result" | "0"                   | 0：执行成功，1：执行失败                                 |
| "error"  | ""                    | 操作成功时为空，操作失败时失败信息（如失败原因、报错等） |

#### 4、查询RTC时间

服务端下发请求：

| 字段     | 内容示例   | 备注                  |
| -------- | ---------- | --------------------- |
| "sn"     | "SN000001" | 设备序列号            |
| "op"     | "query"    | 操作类型：查询        |
| "op_sub" | "RTC"      | 操作子类：查询RTC配置 |

端站响应：

| 字段     | 内容示例     | 备注                   |
| -------- | ------------ | ---------------------- |
| "sn"     | "SN000001"   | 设备序列号             |
| "op"     | "query_ans"  | 操作类型：查询（响应） |
| "op_sub" | "RTC"        | 操作子类：查询RTC配置  |
| "date"   | "2025-08-08" | 日期                   |
| "time"   | "12:08:53"   | 时间                   |

#### 5、设置RTC时间

服务端下发请求：==检查time字段格式==（没看出来为啥会有hms丢失某项的问题

| 字段     | 内容示例          | 备注                  |
| -------- | ----------------- | --------------------- |
| "sn"     | "SN000001"        | 设备序列号            |
| "op"     | "antenna_control" | 操作类型：天线控制    |
| "op_sub" | "set_RTC"         | 操作子类：设置RTC时间 |
| "date"   | "2025-08-08"      | 日期                  |
| "time"   | "12:08:53"        | 时间                  |

端站应答：==修改result==（已完成

| 字段     | 内容示例              | 备注                                                     |
| -------- | --------------------- | -------------------------------------------------------- |
| "sn"     | "SN000001"            | 设备序列号                                               |
| "op"     | "antenna_control_ans" | 操作类型：天线控制（响应）                               |
| "op_sub" | "set_RTC"             | 操作子类：设置RTC时间                                    |
| "result" | "0"                   | 0：操作成功，1：操作失败                                 |
| "error"  | ""                    | 操作成功时为空，操作失败时失败信息（如失败原因、报错等） |

#### 6、上报参数查询

服务端下发请求：

| 字段     | 内容示例        | 备注                   |
| -------- | --------------- | ---------------------- |
| "sn"     | "SN000001"      | 设备序列号             |
| "op"     | "query"         | 操作类型：查询         |
| "op_sub" | "report_config" | 操作子类：查询上报参数 |

端站响应：==添加ip、port、RTC字段==（已完成

| 字段       | 内容示例        | 备注                                     |
| ---------- | --------------- | ---------------------------------------- |
| "sn"       | "SN000001"      | 设备序列号                               |
| "op"       | "query_ans"     | 操作类型：查询（响应）                   |
| "op_sub"   | "report_config" | 操作子类：查询上报参数                   |
| "ip"       | "127.0.0.1"     | 端站上报的IP地址                         |
| "port"     | "8080"          | 端站上报的端口号                         |
| "mode"     | "1"             | 0：不上报，1：通过CPE上报，2：通过NB上报 |
| "RTC"      | "0"             | 0：上报RTC时间，1：不上报RTC时间         |
| "interval" | "60.0"          | 上报间隔时间，单位为秒                   |

*注：这里端站响应实际上还包含两个隐藏字段，即ip和port

#### 7、上报参数设置

服务端下发请求：==添加RTC字段==（已完成

| 字段       | 内容示例            | 备注                                     |
| ---------- | ------------------- | ---------------------------------------- |
| "sn"       | "SN000001"          | 设备序列号                               |
| "op"       | "antenna_control"   | 操作类型：天线控制                       |
| "op_sub"   | "set_report_config" | 操作子类：设置上报参数                   |
| "ip"       | "101.90.22.16"      | 设置端站上报的ip地址                     |
| "port"     | "11789"             | 设置端站上报的端口                       |
| "mode"     | "1"                 | 0：不上报，1：通过CPE上报，2：通过NB上报 |
| "RTC"      | "0"                 | 0：上报RTC时间，1：不上报RTC时间         |
| "interval" | "60.0"              | 上报间隔时间，单位为秒                   |

端站应答：==修改result==（已完成

| 字段     | 内容示例              | 备注                                                     |
| -------- | --------------------- | -------------------------------------------------------- |
| "sn"     | "SN000001"            | 设备序列号                                               |
| "op"     | "antenna_control_ans" | 操作类型：天线控制（响应）                               |
| "op_sub" | "set_report_config"   | 操作子类：设置上报参数                                   |
| "result" | "0"                   | 0：操作成功，1：操作失败                                 |
| "error"  | ""                    | 操作成功时为空，操作失败时失败信息（如失败原因、报错等） |

#### 8、版本查询

服务端下发请求：

| 字段     | 内容示例   | 备注                     |
| -------- | ---------- | ------------------------ |
| "sn"     | "SN000001" | 设备序列号               |
| "op"     | "query"    | 操作类型：查询           |
| "op_sub" | "version"  | 操作子类：查询软硬件版本 |

端站响应：

| 字段           | 内容示例    | 备注                     |
| -------------- | ----------- | ------------------------ |
| "sn"           | "SN000001"  | 设备序列号               |
| "op"           | "query_ans" | 操作类型：查询（响应）   |
| "op_sub"       | "version"   | 操作子类：查询软硬件版本 |
| "model"        | "MBP N28"   | 产品型号                 |
| "hw_version"   | "1.0"       | 硬件版本                 |
| "ADU_version"  | "1.0"       | ADU软件版本              |
| "ACU_version"  | "1.0"       | ACU软件版本              |
| "stru_version" | "1.0"       | 结构版本                 |

#### 9、服务端上传文件至端站

服务端下发请求：==修改op、opsub，添加update_type==（已完成

| 字段          | 内容示例                | 备注                                 |
| ------------- | ----------------------- | ------------------------------------ |
| "sn"          | "SN000001"              | 设备序列号                           |
| "op"          | "update"                | 操作类型：端站升级                   |
| "op_sub"      | "upload_update_file"    | 操作子类：上传升级文件               |
| "update_type" | "0"                     | 0：adu升级文件，1：acu升级文件       |
| "content"     |                         | 用户在页面中选择的要上传的文件       |
| "file_name"   | "ADU软件升级v1.0.1.exe" | 用户在页面中选择的要上传的文件的名称 |

端站响应：==修改op、opsub、result==（已完成

| 字段     | 内容示例             | 备注                                                       |
| -------- | -------------------- | ---------------------------------------------------------- |
| "sn"     | "SN000001"           | 设备序列号                                                 |
| "op"     | "update_ans"         | 操作类型：端站升级                                         |
| "op_sub" | "upload_update_file" | 操作子类：上传升级文件                                     |
| "result" | "0"                  | 0：上传成功，1：上传失败                                   |
| "error"  | ""                   | 上传成功时为空，上传失败时为失败信息（如失败原因、报错等） |

#### 10、端站软件升级

服务端下发请求：==修改opsub，添加update_type==（已完成

| 字段          | 内容示例                | 备注                                   |
| ------------- | ----------------------- | -------------------------------------- |
| "sn"          | "SN000001"              | 设备序列号                             |
| "op"          | "update"                | 操作类型：端站升级                     |
| "op_sub"      | "software_update"       | 操作子类：端站软件升级                 |
| "update_type" | "0"                     | 0：进行adu软件升级，1：进行acu软件升级 |
| "file_name"   | "ADU软件升级v1.0.1.exe" | 用户在页面中选择的文件的名称           |

服务端下发请求：==修改opsub、result==（已完成

| 字段     | 内容示例          | 备注                                                       |
| -------- | ----------------- | ---------------------------------------------------------- |
| "sn"     | "SN000001"        | 设备序列号                                                 |
| "op"     | "update_ans"      | 操作类型：端站更新（响应）                                 |
| "op_sub" | "software_update" | 操作子类：端站软件升级                                     |
| "result" | "0"               | 0：上传成功，1：上传失败                                   |
| "error"  | ""                | 上传成功时为空，上传失败时为失败信息（如失败原因、报错等） |

注：该请求等待时间设置稍长，设置为60秒

==后续改进：可能需要持续通信来显示更新进度==