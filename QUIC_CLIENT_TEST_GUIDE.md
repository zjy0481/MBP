# QUIC客户端测试指南

## 📋 概述

本指南说明如何使用测试客户端与NM_Service_QUIC服务器进行通信测试。

## 🚀 快速开始

### 1. 启动服务器

在第一个终端窗口中启动QUIC服务：

```bash
cd c:/Users/goey8/Desktop/MBP
python manage.py start_nm_service_quic
```

### 2. 启动Daphne Web服务

在第二个终端窗口中启动Daphne服务器：

```bash
cd c:/Users/goey8/Desktop/MBP
daphne -b 127.0.0.1 -p 8000 mbp_project.asgi:application
```

### 3. 运行客户端测试

在第三个终端窗口中启动测试客户端：

```bash
cd c:/Users/goey8/Desktop/MBP
python run_quic_client.py
```

## 📱 客户端功能

### 客户端特性

- **SN标识**: 模拟SN为"sn111111"的设备
- **自动连接**: 连接到QUIC服务器 (127.0.0.1:59999)
- **上报数据**: 发送初始上报数据建立SN映射关系
- **消息回复**: 收到服务器消息后自动回复确认
- **心跳维持**: 每30秒发送心跳包保持连接
- **连接状态**: 实时显示连接状态和消息交互

### 客户端日志说明

- `🚀` - 客户端启动
- `✅` - 连接成功
- `📤` - 发送消息
- `📥` - 接收消息
- `💓` - 心跳包
- `🔌` - 连接状态
- `❌` - 错误信息

## 🔄 测试流程

### 阶段1: 连接建立
1. 客户端连接到QUIC服务器
2. 服务器生成client_id并注册连接
3. 显示连接成功信息

### 阶段2: 映射建立
1. 客户端发送上报数据包含SN="sn111111"
2. 服务器处理上报数据并建立SN→client_id映射
3. 上报数据存储到数据库

### 阶段3: 消息通信
1. 客户端定期发送心跳包
2. 服务器通过Redis发送控制指令到指定SN
3. 客户端收到消息后自动回复确认

### 阶段4: 连接维持
1. 客户端持续保持在线状态
2. 定期心跳维持映射关系
3. 实时响应服务器消息

## 🧪 测试场景

### 测试1: 正常通信
- 启动服务器和客户端
- 观察连接建立和映射创建过程
- 检查客户端成功发送上报数据

### 测试2: 消息转发测试
1. 通过Redis发送控制指令到SN="sn111111"
2. 观察指令通过QUIC转发到客户端
3. 验证客户端回复消息

### 测试3: 连接断开恢复
1. 停止客户端（Ctrl+C）
2. 重新启动客户端
3. 验证新的连接建立和映射更新

## 📊 监控要点

### 服务器端监控
- QUIC服务器启动状态
- Redis连接状态
- 客户端连接数量
- SN映射关系
- 消息转发日志

### 客户端端监控
- 连接建立状态
- 上报数据发送
- 心跳包发送
- 消息接收和回复
- 连接断开处理

## 🔧 故障排除

### 连接失败
- 检查服务器是否在127.0.0.1:59999启动
- 确认防火墙设置
- 验证证书文件是否存在

### 映射未建立
- 检查上报数据格式
- 确认SN字段正确
- 查看服务器日志

### 消息转发失败
- 验证Redis连接状态
- 检查SN映射是否存在
- 确认客户端在线状态

## 📝 扩展功能

### 自定义SN
可以修改`test_quic_client.py`中的`sn`参数来测试不同SN的客户端：

```python
client = QUICTestClient(sn="your_custom_sn")
```

### 自定义消息格式
修改`send_report_data`方法中的数据结构来测试不同的上报格式。

### 批量测试
创建多个客户端实例来模拟多个设备同时连接的情况。

## 🎯 测试目标

通过此测试验证以下功能：
- ✅ QUIC服务器正常启动和运行
- ✅ 客户端连接建立和认证
- ✅ SN到client_id映射机制
- ✅ 上报数据处理和存储
- ✅ Redis指令转发到QUIC客户端
- ✅ 客户端消息接收和回复
- ✅ 心跳维持和连接管理
- ✅ 异常处理和错误恢复

---

**注意**: 确保所有服务（Redis、Django、Daphne、QUIC服务器）都在运行状态才能进行完整测试。