{% extends 'base.html' %}
{% load static %}

{% block title %}日志信息 - {{ block.super }}{% endblock %}

{% block content %}
<style type="text/css">
    #logTable tr:hover { background-color: #f5f5f5 !important; }
</style>

<h2>日志信息</h2>
<hr>

<table id="logTable" class="table table-striped table-sm">
    <thead class="table-dark">
        <tr>
            <th scope="col" style="width: 10%; text-align: center;">序号</th>
            <th scope="col" style="width: 10%; text-align: center;">级别</th>
            <th scope="col" style="width: 20%; text-align: center;">时间</th>
            <th scope="col">信息</th>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>

<script type="text/javascript">
    // 页面加载完成时，通知父页面(主页)的index.js，日志窗口已准备就绪
    window.onload = function(e){
        if (window.parent && typeof window.parent.logReady !== 'undefined') {
            window.parent.logReady = true;
        }
    }

    function addLog(msg) {
        var level = msg["level"];
        var time = msg["time"];
        var message = msg["msg"];

        var logTableBody = document.querySelector("#logTable tbody");
        // insertRow(0) 会将新行插入到表格的最顶部
        var newRow = logTableBody.insertRow(0); 

        var newCellSn = newRow.insertCell(0);
        newCellSn.style.textAlign = "center";
        // 动态计算序号，使其保持从1开始递增
        for (var i = 0; i < logTableBody.rows.length; i++) {
            logTableBody.rows[i].cells[0].innerText = logTableBody.rows.length - i;
        }

        var newCellLevel = newRow.insertCell(1);
        newCellLevel.style.textAlign = "center";
        
        // 根据日志级别设置文本和背景色
        switch (level) {
            case 0: //debug
                newCellLevel.innerText = "调试";
                break;
            case 1: //info
                newCellLevel.innerText = "信息";
                break;
            case 2: //warning
                newCellLevel.innerText = "警告";
                newRow.className = "table-warning"; // 使用Bootstrap的样式
                break;
            case 3: //error
                newCellLevel.innerText = "错误";
                newRow.className = "table-danger"; // 使用Bootstrap的样式
                break;
            case 4: //critical
                newCellLevel.innerText = "严重";
                newRow.className = "table-danger fw-bold"; // 加粗
                break;
            default:
                newCellLevel.innerText = "未知";
        }
        
        var newCellTime = newRow.insertCell(2);
        newCellTime.style.textAlign = "center";
        newCellTime.innerText = time;

        var newCellMessage = newRow.insertCell(3);
        newCellMessage.innerText = message;
    }

    function addLog_T(level, message){
        // 创建当前时间字符串 (UTC+8)
        let time = new Date(+new Date() + 8 * 3600 * 1000).toISOString().replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '');

        var msg_object = {
            "level": level,
            "time": time,
            "msg": message
        };
        addLog(msg_object);
    }

    function test(){
        var msg = {
            cmd:0xF1,
            level:1,
            time:"2021-06-01 10:33:56",
            msg:"happy kids day."
        };
        addLog(msg);
        var msg1 = {
            cmd:0xF1,
            level:2,
            time:"2021-06-01 10:33:56",
            msg:"happy kids day."
        };
        addLog(msg1);
        var msg2 = {
            cmd:0xF1,
            level:3,
            time:"2021-06-01 10:33:56",
            msg:"happy kids day."
        };
        addLog(msg2);

        // 测试
        addLog_T(1, "这是测试");
    }
</script>
{% endblock %}